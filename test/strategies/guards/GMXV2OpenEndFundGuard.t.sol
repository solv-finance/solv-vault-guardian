// SPDX-License-Identifier: MIT

pragma solidity 0.8.21;

import "forge-std/Test.sol";
import "forge-std/console.sol";
import "../../common/SafeguardBaseTest.sol";
import "../../../src/strategies/guards/GMXV2OpenEndFundGuard.sol";

contract GMXV2OpenEndFundGuardTest is SafeguardBaseTest {

    address public constant GMX_EXCHANGE_ROUTER = 0x7C68C7866A64FA2160F78EEaE12217FFbf871fa8;
    address public constant GMX_DEPOSIT_VAULT = 0xF89e77e8Dc11691C9e8757e84aaFbCD8A67d7A55;
    address public constant GMX_WITHDRAWAL_VAULT = 0x0628D46b5D145f183AdB6Ef1f2c97eD1C4701C55;

	GMXV2OpenEndFundGuard internal _gmxV2OpenEndFundGuard;

	function setUp() public override {
		super.setUp();
		_gmxV2OpenEndFundGuard = new GMXV2OpenEndFundGuard(SAFE_ACCOUNT);
	}

	function test_buyGM_success() public {
		BaseGuard.CheckResult memory result = _send_txData_to_gmxExchangeRouter(
			hex"ac9650d800000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000000447d39aaf1000000000000000000000000f89e77e8dc11691c9e8757e84aafbcd8a67d7a550000000000000000000000000000000000000000000000000002a84d524ac000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000064e6d66ac8000000000000000000000000af88d065e77c8cc2239327c5edb3a432268e5831000000000000000000000000f89e77e8dc11691c9e8757e84aafbcd8a67d7a5500000000000000000000000000000000000000000000000000000000000f42400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e45b4e956100000000000000000000000000000000000000000000000000000000000000200000000000000000000000009b1cf397c9ecdd70f76d0b6f51a2582eeeed2eb70000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000047c031236e19d024b42f8ae6780e44a5731707030000000000000000000000002f2a2543b76a4166549f7aab2e75bef0aefc5b0f000000000000000000000000af88d065e77c8cc2239327c5edb3a432268e5831000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000001a00000000000000000000000000000000000000000000000000c38a414d6e6f18100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002a84d524ac00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
		);
		assertTrue(result.success);
	}

	function test_buy_unauthorized_GM_fail() public {
		BaseGuard.CheckResult memory result = _send_txData_to_gmxExchangeRouter(
			hex"ac9650d800000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000000447d39aaf1000000000000000000000000f89e77e8dc11691c9e8757e84aafbcd8a67d7a550000000000000000000000000000000000000000000000000002a84d524ac000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000064e6d66ac8000000000000000000000000af88d065e77c8cc2239327c5edb3a432268e5831000000000000000000000000f89e77e8dc11691c9e8757e84aafbcd8a67d7a5500000000000000000000000000000000000000000000000000000000000f42400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e45b4e956100000000000000000000000000000000000000000000000000000000000000200000000000000000000000009b1cf397c9ecdd70f76d0b6f51a2582eeeed2eb700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c25cef6061cf5de5eb761b50e4743c1f5d7e54070000000000000000000000002f2a2543b76a4166549f7aab2e75bef0aefc5b0f000000000000000000000000af88d065e77c8cc2239327c5edb3a432268e5831000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000001a00000000000000000000000000000000000000000000000000c38a414d6e6f18100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002a84d524ac00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
		);
		assertFalse(result.success);
	}

	function test_buyGM_with_unauthorized_token_fail() public {
		BaseGuard.CheckResult memory result = _send_txData_to_gmxExchangeRouter(
			hex"ac9650d800000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000000447d39aaf1000000000000000000000000f89e77e8dc11691c9e8757e84aafbcd8a67d7a550000000000000000000000000000000000000000000000000002a84d524ac000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000064e6d66ac8000000000000000000000000fd086bc7cd5c481dcc9c85ebe478a1c0b69fcbb9000000000000000000000000f89e77e8dc11691c9e8757e84aafbcd8a67d7a5500000000000000000000000000000000000000000000000000000000000f42400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e45b4e956100000000000000000000000000000000000000000000000000000000000000200000000000000000000000009b1cf397c9ecdd70f76d0b6f51a2582eeeed2eb70000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000047c031236e19d024b42f8ae6780e44a5731707030000000000000000000000002f2a2543b76a4166549f7aab2e75bef0aefc5b0f000000000000000000000000fd086bc7cd5c481dcc9c85ebe478a1c0b69fcbb9000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000001a00000000000000000000000000000000000000000000000000c38a414d6e6f18100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002a84d524ac00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
		);
		assertFalse(result.success);
	}

	function test_buyGM_to_other_address_fail() public {
		BaseGuard.CheckResult memory result = _send_txData_to_gmxExchangeRouter(
			hex"ac9650d800000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000000447d39aaf1000000000000000000000000f89e77e8dc11691c9e8757e84aafbcd8a67d7a550000000000000000000000000000000000000000000000000002a84d524ac000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000064e6d66ac8000000000000000000000000af88d065e77c8cc2239327c5edb3a432268e5831000000000000000000000000f89e77e8dc11691c9e8757e84aafbcd8a67d7a5500000000000000000000000000000000000000000000000000000000000f42400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e45b4e956100000000000000000000000000000000000000000000000000000000000000200000000000000000000000009b1cf397c9ecdd70f76d0b6f51a2582eeeed2eb70000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000047c031236e19d024b42f8ae6780e44a5731707030000000000000000000000002f2a2543b76a4166549f7aab2e75bef0aefc5b0f000000000000000000000000af88d065e77c8cc2239327c5edb3a432268e5831000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000001a00000000000000000000000000000000000000000000000000c38a414d6e6f18100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002a84d524ac00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
		);
		assertTrue(result.success);
	}

	function test_sellGM_success() public {
		BaseGuard.CheckResult memory result = _send_txData_to_gmxExchangeRouter(
			hex"ac9650d800000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000000447d39aaf10000000000000000000000000628d46b5d145f183adb6ef1f2c97ed1c4701c550000000000000000000000000000000000000000000000000002a84d524ac000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000064e6d66ac800000000000000000000000047c031236e19d024b42f8ae6780e44a5731707030000000000000000000000000628d46b5d145f183adb6ef1f2c97ed1c4701c5500000000000000000000000000000000000000000000000002c68af0bb1400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001c4ad23c5a100000000000000000000000000000000000000000000000000000000000000200000000000000000000000009b1cf397c9ecdd70f76d0b6f51a2582eeeed2eb70000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000047c031236e19d024b42f8ae6780e44a57317070300000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000014c000000000000000000000000000000000000000000000000000000000001aaa300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002a84d524ac00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
		);
		assertTrue(result.success);
	}

	function test_sell_unauthorized_GM_fail() public {
		BaseGuard.CheckResult memory result = _send_txData_to_gmxExchangeRouter(
			hex"ac9650d800000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000000447d39aaf10000000000000000000000000628d46b5d145f183adb6ef1f2c97ed1c4701c550000000000000000000000000000000000000000000000000002a84d524ac000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000064e6d66ac8000000000000000000000000c25cef6061cf5de5eb761b50e4743c1f5d7e54070000000000000000000000000628d46b5d145f183adb6ef1f2c97ed1c4701c5500000000000000000000000000000000000000000000000002c68af0bb1400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001c4ad23c5a100000000000000000000000000000000000000000000000000000000000000200000000000000000000000009b1cf397c9ecdd70f76d0b6f51a2582eeeed2eb700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c25cef6061cf5de5eb761b50e4743c1f5d7e540700000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000014c000000000000000000000000000000000000000000000000000000000001aaa300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002a84d524ac00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
		);
		assertFalse(result.success);
	}

	function test_sellGM_fail() public {
		BaseGuard.CheckResult memory result = _send_txData_to_gmxExchangeRouter(
			hex"ac9650d800000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000000447d39aaf10000000000000000000000000628d46b5d145f183adb6ef1f2c97ed1c4701c550000000000000000000000000000000000000000000000000002a84d524ac000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000064e6d66ac800000000000000000000000047c031236e19d024b42f8ae6780e44a5731707030000000000000000000000000628d46b5d145f183adb6ef1f2c97ed1c4701c5500000000000000000000000000000000000000000000000002c68af0bb1400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001c4ad23c5a100000000000000000000000000000000000000000000000000000000000000200000000000000000000000009b1cf397c9ecdd70f76d0b6f51a2582eeeed2eb70000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000047c031236e19d024b42f8ae6780e44a57317070300000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000014c000000000000000000000000000000000000000000000000000000000001aaa300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002a84d524ac00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
		);
		assertTrue(result.success);
	}

	function _send_txData_to_gmxExchangeRouter(bytes memory data) internal returns (BaseGuard.CheckResult memory) {
		BaseGuard.TxData memory txData = BaseGuard.TxData({
			from: _msgSender,
			to: GMX_EXCHANGE_ROUTER,
			value: 0,
			data: data
		});
		return _gmxV2OpenEndFundGuard.checkTransaction(txData);
	}

}